{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mytube</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">MyTube</a>

    <!-- Search Form -->
    <form class="d-flex me-auto" method="GET" onsubmit="event.preventDefault(); searchSubtitles();">
      <input class="form-control me-2" id="search-input" type="search" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success" type="submit">Search</button>
    </form>

    <!-- Navbar Toggler for Mobile View -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'list_view' %}">Uploaded videos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload Videos</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


<!-- Modal for Uploading Videos -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">Upload Videos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" enctype="multipart/form-data" action="{% url 'upload_video' %}">
          {% csrf_token %}
          <div class="mb-3">
              <label for="id_title" class="form-label">Video Title</label>
              <input type="text" class="form-control" id="id_title" name="title" placeholder="Enter a title for your video">
          </div>
          <div class="mb-3">
              <label for="id_file" class="form-label">Choose Video File</label>
              <input type="file" class="form-control" id="id_file" name="file">
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="container mt-5">
    <h2>My Videos</h2>
    <div class="row">
        {% for video in videos %}
            <div class="col-md-4">
                <div class="card video-card" style="width: 380px; margin-bottom: 20px;">
                    <video id="video_{{ video.pk }}" controls class="card-img-top video-player" style="width: 100%; height: 280px; object-fit: cover;" >
                        <source src="{{ video.file.url }}" type="video/mp4">
                        {% if video.subtitle_file %}
                        <track src="{{ video.subtitle_file.url }}" kind="subtitles" srclang="en" label="English" default>
                        {% endif %}
                        {% if video.subtitle_file_fr %}
                        <track kind="subtitles" src="{{ video.subtitle_file_fr.url }}" srclang="fr" label="French">
                        {% endif %}
                        {% if video.subtitle_file_es %}
                        <track kind="subtitles" src="{{ video.subtitle_file_es.url }}" srclang="es" label="Spanish">
                        {% endif %}
                         {% if video.subtitle_file_hi %}
                         <track kind="subtitles" src="{{ video.subtitle_file_hi.url }}" srclang="hi" label="Hindi">
                        {% endif %}
                        Your browser does not support the video tag.
                    </video>
                    <div class="card-body" style="text-align: center;">
                        <h5 class="card-title">{{ video.title }}</h5>
                        <p class="card-text">Uploaded on {{ video.uploaded_at }}</p>
                        <form method="post" action="{% url 'delete_video' video.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Modal for Search Results -->
<div class="modal fade" id="searchResultsModal" tabindex="-1" aria-labelledby="searchResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchResultsModalLabel">Search Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Search results will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom Script for AJAX Search -->
<script>
function seekVideo(timestamp) {
    // Find the video element by its ID
    const videoElement = document.getElementById('video_player');

    if (videoElement) {
        // Split the timestamp into hours, minutes, seconds (with milliseconds)
        const timeParts = timestamp.split(':');
        const hours = parseInt(timeParts[0], 10) || 0;
        const minutes = parseInt(timeParts[1], 10) || 0;
        const secondsAndMs = parseFloat(timeParts[2]) || 0; // seconds + milliseconds
        const totalSeconds = (hours * 3600) + (minutes * 60) + secondsAndMs;

        // Debugging - log totalSeconds
        console.log('Seeking to:', totalSeconds, 'seconds');

        // Set the video playback time
        videoElement.currentTime = totalSeconds;

        // Play the video from the specified timestamp
        videoElement.play();
    } else {
        console.error('Video element not found!');
    }
}
function searchSubtitles() {
    const query = document.getElementById('search-input').value.trim();

    if (query) {
        fetch(`/search/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                const modalBody = document.getElementById('modal-body-content');
                modalBody.innerHTML = '';

                if (data.results.length > 0) {
                    data.results.forEach(result => {
                        modalBody.innerHTML += `
                            <div class="result-item">
                                <h5>${result.video.title}</h5>
                                <p>Phrase: "${result.phrase}" found at <a href="javascript:void(0);" onclick="seekVideo(${result.video.id}, '${result.timestamp}')">${result.timestamp}</a></p>
                            </div>`;
                    });
                } else {
                    modalBody.innerHTML = '<p>No results found.</p>';
                }


                const modal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
                modal.show();
            })
            .catch(error => console.error('Error:', error));
    }
}
</script>

</body>
</html>